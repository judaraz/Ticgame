<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Player vs Computer</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://ads.adsgram.tech/sdk.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap');
  html, body {
    margin: 0; padding: 0;
    height: 100%;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: #fff;
    user-select: none;
    overflow-x: hidden;
  }
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 15px 10px 40px;
    min-height: 100vh;
    position: relative;
  }
  h2 {
    font-weight: 600;
    font-size: clamp(1.8rem, 5vw, 2.8rem);
    margin-top: 12px;
    text-shadow: 0 2px 8px rgba(0,0,0,0.25);
  }
  #status {
    margin: 12px 0 6px 0;
    font-size: clamp(1rem, 3vw, 1.3rem);
    letter-spacing: 1.2px;
    text-shadow: 0 1px 6px rgba(0,0,0,0.3);
  }
  #points {
    margin-bottom: 20px;
    font-size: clamp(0.9rem, 2.5vw, 1.1rem);
    opacity: 0.85;
    text-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  #game {
    display: grid;
    grid-template-columns: repeat(3, minmax(80px, 1fr));
    gap: clamp(10px, 3vw, 18px);
    width: 100%;
    max-width: 400px;
    padding: 28px;
    border-radius: 30px;
    background: linear-gradient(145deg, #ffffff33, #00000033);
    box-shadow:
      0 10px 40px rgba(0, 0, 0, 0.25),
      inset 0 0 40px rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    position: relative;
    z-index: 5;
  }
  .cell {
    aspect-ratio: 1 / 1;
    font-size: clamp(30px, 12vw, 60px);
    border-radius: 25px;
    background: linear-gradient(135deg, #ffffff22, #ffffff11);
    box-shadow:
      4px 4px 15px rgba(0,0,0,0.3),
      inset 2px 2px 6px rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #eee;
    user-select: none;
    transition: all 0.3s ease;
    text-shadow: 0 0 6px rgba(0,0,0,0.7);
  }
  .cell:hover {
    background: linear-gradient(135deg, #fff1, #fff4);
    box-shadow:
      0 0 18px 4px #5a7fffaa,
      inset 2px 2px 12px rgba(255, 255, 255, 0.6);
    color: #2a2a2a;
  }
  .cell.X {
    color: #00ff88;
    text-shadow: 0 0 12px #00ff88;
  }
  .cell.O {
    color: #ff3f6c;
    text-shadow: 0 0 12px #ff3f6c;
  }
  #restart {
    margin-top: 10px;
    padding: clamp(10px, 3vw, 14px) clamp(24px, 6vw, 38px);
    font-size: clamp(1rem, 3vw, 1.3rem);
    font-weight: 600;
    border-radius: 30px;
    border: none;
    background: linear-gradient(90deg, #ff416c, #ff4b2b);
    box-shadow:
      0 8px 18px #ff4b2baa,
      0 0 30px #ff416caa inset;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
    z-index: 5;
  }
  #restart:hover {
    background: linear-gradient(90deg, #ff4b2b, #ff416c);
    box-shadow:
      0 12px 28px #ff4b2bcc,
      0 0 40px #ff416ccc inset;
  }

  @keyframes flash-win {
    0%, 100% { background-color: transparent; box-shadow: none; }
    25% { background-color: #ffff33aa; box-shadow: 0 0 15px #ffff33; }
    50% { background-color: #ffff66cc; box-shadow: 0 0 25px #ffff66; }
    75% { background-color: #ffff99ee; box-shadow: 0 0 35px #ffff99; }
  }
  .flash {
    animation: flash-win 0.6s ease-in-out 4;
    border-color: gold !important;
  }

  #particles-container {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    pointer-events: none;
    overflow: visible;
    z-index: 50;
  }
  .particle {
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    opacity: 1;
    filter: drop-shadow(0 0 6px currentColor);
    animation: firework-rise 700ms ease-out forwards,
               firework-explode 800ms ease-out 700ms forwards;
  }
  @keyframes firework-rise {
    0% {
      transform: translate(0, 0) scale(1);
      opacity: 1;
    }
    100% {
      transform: translate(var(--dx), var(--dy)) scale(0.7);
      opacity: 1;
    }
  }
  @keyframes firework-explode {
    0% {
      transform: translate(var(--dx), var(--dy)) scale(0.7);
      opacity: 1;
      box-shadow: 0 0 0 currentColor;
    }
    100% {
      transform: translate(calc(var(--dx) * 1.8), calc(var(--dy) * 1.8)) scale(0.3);
      opacity: 0;
      box-shadow:
        0 0 20px currentColor,
        0 0 40px currentColor,
        0 0 60px currentColor;
    }
  }

  #adsgram-container {
    margin-top: 25px;
    max-width: 350px;
    width: 100%;
    z-index: 20;
    position: relative;
  }

  /* Result overlay */
  #result-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #ffd700cc, #ffa500cc);
    border-radius: 20px;
    padding: 30px 50px;
    box-shadow: 0 0 25px 8px #ffd700cc, inset 0 0 15px 4px #ffa500cc;
    font-size: clamp(2.8rem, 8vw, 4rem);
    font-weight: 800;
    color: #fff;
    text-align: center;
    user-select: none;
    z-index: 100;
    pointer-events: none;
    text-shadow:
      0 0 15px #fff,
      0 0 25px #ffd700,
      0 0 35px #ffa500;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  #result-overlay.show {
    opacity: 1;
    pointer-events: auto;
  }
</style>
</head>
<body>
<h2>Player vs Computer</h2>
<div id="status">Your turn (X)</div>
<div id="points">Points: 0</div>
<div id="game"></div>
<button id="restart">Restart</button>
<div id="adsgram-container"></div>
<div id="particles-container"></div>

<div id="result-overlay"></div>

<audio id="gameover-sound" src="https://www.soundjay.com/button/sounds/button-29.mp3" preload="auto"></audio>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  const game = document.getElementById("game");
  const statusText = document.getElementById("status");
  const restartBtn = document.getElementById("restart");
  const gameoverSound = document.getElementById("gameover-sound");
  const adsContainer = document.getElementById("adsgram-container");
  const pointsText = document.getElementById("points");
  const particlesContainer = document.getElementById("particles-container");
  const resultOverlay = document.getElementById("result-overlay");

  let board = ["", "", "", "", "", "", "", "", ""];
  let gameActive = true;
  let points = 0;

  const winningCombinations = [
    [0,1,2], [3,4,5], [6,7,8],
    [0,3,6], [1,4,7], [2,5,8],
    [0,4,8], [2,4,6]
  ];

  function createBoard() {
    game.innerHTML = "";
    for (let i = 0; i < 9; i++) {
      const cell = document.createElement("div");
      cell.id = `cell-${i}`;
      cell.className = "cell";
      cell.addEventListener("click", () => {
        if (!gameActive) return;
        playerMove(i);
      });
      game.appendChild(cell);
    }
  }

  function updateBoard() {
    for (let i = 0; i < 9; i++) {
      const cell = document.getElementById(`cell-${i}`);
      cell.textContent = board[i];
      cell.className = "cell " + board[i];
    }
  }

  function getEmptyIndices() {
    return board.map((v, i) => v === "" ? i : null).filter(v => v !== null);
  }

  function checkWin(player) {
    for (const combo of winningCombinations) {
      if (combo.every(i => board[i] === player)) {
        return combo;
      }
    }
    return null;
  }

  function isDraw() {
    return board.every(cell => cell !== "");
  }

  function flashWinningCells(combo) {
    combo.forEach(i => {
      const cell = document.getElementById(`cell-${i}`);
      cell.classList.add("flash");
    });
  }

  const sparkleColors = [
    '#FF3F6C', '#00FF88', '#FFD700', '#FF6F00',
    '#00BFFF', '#FF4500', '#8A2BE2', '#00CED1'
  ];

  // Fireworks particle effect
  function showFireworks(x = window.innerWidth/2, y = window.innerHeight/2, count = 40) {
    for (let i = 0; i < count; i++) {
      const particle = document.createElement("div");
      particle.className = "particle";

      // Angle from 0 to 2pi
      const angle = Math.random() * 2 * Math.PI;
      // Distance for rise and explode
      const riseDist = 80 + Math.random() * 80;
      const explodeDist = riseDist * (1.5 + Math.random());

      // Rise position offset (mostly upward with some horizontal)
      const dxRise = riseDist * Math.cos(angle) * 0.3;
      const dyRise = -riseDist * Math.sin(angle);

      // Explode position offset further
      const dxExplode = explodeDist * Math.cos(angle);
      const dyExplode = -explodeDist * Math.sin(angle);

      // We use CSS variables --dx and --dy for animations (explode target)
      particle.style.setProperty('--dx', `${dxExplode}px`);
      particle.style.setProperty('--dy', `${dyExplode}px`);

      // Start position for rise animation
      particle.style.left = `${x + dxRise}px`;
      particle.style.top = `${y + dyRise}px`;

      // Random color from palette
      particle.style.color = sparkleColors[Math.floor(Math.random() * sparkleColors.length)];

      particlesContainer.appendChild(particle);

      // Remove particle after animation
      setTimeout(() => {
        if (particle.parentNode) particle.parentNode.removeChild(particle);
      }, 1600);
    }
  }

  function showResultOverlay(text) {
    resultOverlay.textContent = text;
    resultOverlay.classList.add("show");
    // Center for fireworks: middle of overlay
    const rect = resultOverlay.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    const cy = rect.top + rect.height/2;
    showFireworks(cx, cy, 60);
  }

  function hideResultOverlay() {
    resultOverlay.classList.remove("show");
  }

  function playGameOverSound() {
    gameoverSound.currentTime = 0;
    gameoverSound.play();
  }

  function updatePoints(value) {
    points += value;
    pointsText.textContent = `Points: ${points}`;
  }

  function computerMove() {
    const empty = getEmptyIndices();

    // 1. Can computer win?
    for (const i of empty) {
      board[i] = "O";
      if (checkWin("O")) {
        updateBoard();
        return i;
      }
      board[i] = "";
    }
    // 2. Block player win
    for (const i of empty) {
      board[i] = "X";
      if (checkWin("X")) {
        board[i] = "O";
        updateBoard();
        return i;
      }
      board[i] = "";
    }
    // 3. Random
    const choice = empty[Math.floor(Math.random() * empty.length)];
    board[choice] = "O";
    updateBoard();
    return choice;
  }

  function playerMove(i) {
    if (board[i] !== "") return;
    board[i] = "X";
    updateBoard();

    let winCombo = checkWin("X");
    if (winCombo) {
      gameActive = false;
      flashWinningCells(winCombo);
      updatePoints(10);
      statusText.textContent = "You win!";
      showResultOverlay("You Win!");
      playGameOverSound();
      return;
    }

    if (isDraw()) {
      gameActive = false;
      updatePoints(2);
      statusText.textContent = "It's a draw.";
      showResultOverlay("Draw!");
      playGameOverSound();
      return;
    }

    // Computer turn
    statusText.textContent = "Computer's turn (O)";
    setTimeout(() => {
      const compIndex = computerMove();
      let compWinCombo = checkWin("O");
      if (compWinCombo) {
        gameActive = false;
        flashWinningCells(compWinCombo);
        updatePoints(-5);
        statusText.textContent = "Computer wins.";
        showResultOverlay("You Lose!");
        playGameOverSound();
        return;
      }

      if (isDraw()) {
        gameActive = false;
        updatePoints(2);
        statusText.textContent = "It's a draw.";
        showResultOverlay("Draw!");
        playGameOverSound();
        return;
      }

      statusText.textContent = "Your turn (X)";
    }, 500);
  }

  restartBtn.addEventListener("click", () => {
    board = ["", "", "", "", "", "", "", "", ""];
    gameActive = true;
    updateBoard();
    statusText.textContent = "Your turn (X)";
    hideResultOverlay();
  });

  createBoard();
  updateBoard();

  // Initialize Adsgram ad
  ads.init({
    container: "#adsgram-container",
    id: "int-11206",
    adtype: "native",
    adcount: 1,
    style: {
      width: "100%",
      height: "90px",
      borderRadius: "20px",
      border: "none",
      marginTop: "25px",
    },
    onError: (err) => {
      console.error("Adsgram error:", err);
    }
  });
</script>
</body>
</html>
