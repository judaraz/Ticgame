<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CashReward App</title>

<!-- RichAds SDK -->
<script src="https://richinfo.co/richpartners/telegram/js/tg-ob.js"></script>
<script>
window.TelegramAdsController = new TelegramAdsController();
window.TelegramAdsController.initialize({ pubId: "956231", appId: "5572", push: true, interstitial: true });
let richReady = false;
window.TelegramAdsController.onReady(() => { richReady = true; });
</script>

<!-- Tailwind & Fonts -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
body { font-family: 'Poppins', sans-serif; background-color: #1a1a1a; color: #fff; }
.main-bg { background-color: #1a1a1a; }
.card-bg { background-color: #2c2c2c; }
.btn-accent { background-color: #fbbf24; color: #000; border-radius: 0.375rem; }
.hidden { display: none; }
#loader { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: flex; align-items: center; justify-content: center; z-index: 50; }
.animate-spin { border: 4px solid #f3f3f3; border-top: 4px solid #fbbf24; border-radius: 50%; width: 64px; height: 64px; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body class="max-w-md mx-auto relative">

<!-- Loader -->
<div id="loader" class="hidden">
  <div class="animate-spin"></div>
</div>

<!-- Auth Section -->
<div id="auth-section" class="min-h-screen flex flex-col justify-center items-center main-bg p-6">
  <h1 class="text-2xl mb-4">Login / Register</h1>
  <input id="email" type="email" placeholder="Email" class="mb-2 p-2 w-full rounded"/>
  <input id="password" type="password" placeholder="Password" class="mb-2 p-2 w-full rounded"/>
  <button id="login-btn" class="btn-accent mb-2 w-full py-2">Login</button>
  <button id="register-btn" class="btn-accent w-full py-2">Register</button>
</div>

<!-- Main App -->
<div id="app-container" class="min-h-screen flex-col main-bg p-4 hidden">
  <h1 class="text-xl mb-4">Welcome, <span id="username">User</span></h1>
  <p>Balance: <span id="balance">0</span> coins</p>
  <button id="claim-ad-btn" class="btn-accent mt-4 w-full py-2">Watch Ad & Claim Reward</button>
  <button id="logout-btn" class="btn-accent mt-4 w-full py-2">Logout</button>
</div>

<!-- Alerts -->
<div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="card-bg rounded-lg p-6 w-full max-w-sm text-center">
    <p id="alert-message" class="mb-4"></p>
    <button id="alert-ok-btn" class="btn-accent px-6 py-2">OK</button>
  </div>
</div>

<!-- Special Ad Popup -->
<div id="special-ad-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="card-bg rounded-lg p-6 w-full max-w-sm text-center">
    <h2 class="mb-2">Special Ad Task!</h2>
    <p id="special-ad-timer-total" class="mb-4">60</p>
    <button id="special-ad-claim" class="btn-accent px-6 py-2">Claim Reward</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyA3palpYZDFdNpBDIF564YsiOAN2dtbxzA",
  authDomain: "tic-tac-toe-87d49.firebaseapp.com",
  projectId: "tic-tac-toe-87d49",
  storageBucket: "tic-tac-toe-87d49.firebasestorage.app",
  messagingSenderId: "1051665363188",
  appId: "1:1051665363188:web:c6389dddb74491a14ceea1"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let userData = { balance: 0, dailyAdCount: 0 };
let appConfig = { adWatchReward: 10, watchAdSpecialTaskCount: 5, watchAdSpecialTaskTimer: 60 };

// Loader
const loader = document.getElementById('loader');
function showLoader(){ loader.style.display='flex'; }
function hideLoader(){ loader.style.display='none'; }

// Alerts
function showAlert(message){ 
  const alertBox=document.getElementById('custom-alert');
  document.getElementById('alert-message').textContent=message;
  alertBox.classList.remove('hidden');
}
document.getElementById('alert-ok-btn').addEventListener('click',()=>document.getElementById('custom-alert').classList.add('hidden'));

// Auth UI
const authSection = document.getElementById('auth-section');
const appContainer = document.getElementById('app-container');

document.getElementById('login-btn').addEventListener('click', async ()=>{
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  showLoader();
  try {
    await signInWithEmailAndPassword(auth,email,password);
  } catch(e){ showAlert(e.message); }
  finally{ hideLoader(); }
});
document.getElementById('register-btn').addEventListener('click', async ()=>{
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  showLoader();
  try {
    const userCredential = await createUserWithEmailAndPassword(auth,email,password);
    await setDoc(doc(db,'users',userCredential.user.uid),{ balance:0,dailyAdCount:0 });
  } catch(e){ showAlert(e.message); }
  finally{ hideLoader(); }
});
document.getElementById('logout-btn').addEventListener('click',async()=>{ showLoader(); await signOut(auth); hideLoader(); });

// Show RichAd
async function showRichAd(){
  return new Promise((resolve,reject)=>{
    if(!window.TelegramAdsController||!richReady) return reject("Ad not ready.");
    try{
      window.TelegramAdsController.show();
      setTimeout(()=>{ try{ window.TelegramAdsController.push(); }catch(e){} },400);
      resolve(true);
    }catch(e){ reject("Failed to show ad."); }
  });
}

// Update balance
async function updateBalance(amount){
  if(!currentUser) return;
  const newBalance=(userData.balance||0)+amount;
  await updateDoc(doc(db,'users',currentUser.uid),{ balance:newBalance });
  userData.balance=newBalance;
  document.getElementById('balance').textContent=newBalance;
}

// Claim ad reward
document.getElementById('claim-ad-btn').addEventListener('click',async()=>{
  showLoader();
  try{
    userData.dailyAdCount=(userData.dailyAdCount||0)+1;
    await updateDoc(doc(db,'users',currentUser.uid),{ dailyAdCount:userData.dailyAdCount });
    
    if(userData.dailyAdCount % appConfig.watchAdSpecialTaskCount ===0){
      document.getElementById('special-ad-timer-total').textContent=appConfig.watchAdSpecialTaskTimer;
      document.getElementById('special-ad-popup').classList.remove('hidden');
    } else {
      await showRichAd();
      await updateBalance(appConfig.adWatchReward);
      showAlert(`You earned ${appConfig.adWatchReward} coins!`);
    }
  } catch(err){ showAlert(err); }
  finally{ hideLoader(); }
});

// Special ad popup claim
document.getElementById('special-ad-claim').addEventListener('click',async()=>{
  showLoader();
  try{
    await showRichAd();
    const reward=appConfig.adWatchReward*2;
    await updateBalance(reward);
    showAlert(`Special reward: ${reward} coins!`);
    document.getElementById('special-ad-popup').classList.add('hidden');
  } catch(e){ showAlert(e); }
  finally{ hideLoader(); }
});

// Auth State
onAuthStateChanged(auth, async user=>{
  showLoader();
  if(user){
    currentUser=user;
    const docSnap = await getDoc(doc(db,'users',user.uid));
    if(docSnap.exists()){ userData=docSnap.data(); }
    document.getElementById('username').textContent=user.email.split('@')[0];
    document.getElementById('balance').textContent=userData.balance;
    authSection.classList.add('hidden');
    appContainer.classList.remove('hidden');
  } else{
    currentUser=null;
    authSection.classList.remove('hidden');
    appContainer.classList.add('hidden');
  }
  hideLoader();
});
</script>
</body>
</html>
