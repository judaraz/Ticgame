<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Player vs Computer</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://ad.gigapub.tech/script?id=978"></script>
<style>
/* Intro Screen */
#intro-screen{
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background: linear-gradient(45deg, #ff416c, #ff4b2b, #1c92d2, #f2fcfe);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  color:white;
  font-family:'Segoe UI',sans-serif;
  font-weight:bold;
  font-size:2em;
  text-align:center;
  animation: backgroundAnimation 5s linear infinite;
  z-index:9999;
}
@keyframes backgroundAnimation{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}
#intro-screen div{
  opacity:0;
  animation: fadeIn 1s forwards;
}
#intro-screen div:nth-child(1){animation-delay:0.5s;}
#intro-screen div:nth-child(2){animation-delay:1.5s;}
#intro-screen div:nth-child(3){animation-delay:2.5s;}
@keyframes fadeIn{
  to{opacity:1;}
}
/* Rainbow Text */
#rainbow-text {
  font-weight: bold;
  font-size: 2.2em;
  background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-size: 400% 400%;
  animation: rainbowMove 3s linear infinite;
}
@keyframes rainbowMove {
  0% {background-position:0% 50%;}
  50% {background-position:100% 50%;}
  100% {background-position:0% 50%;}
}

/* Star Canvas */
#star-canvas{
  position:fixed; top:0; left:0;
  width:100%; height:100%;
  z-index:0; pointer-events:none;
}

/* Game Styles */
body{margin:0;padding:0;font-family:'Segoe UI',sans-serif;background:#0e0e0e;color:#fff;text-align:center;}
#main-game{display:none; position:relative; z-index:1;} /* Hidden initially */
h2{margin-top:20px;font-size:24px;font-weight:600;}
#status,#level,#points{margin-top:10px;font-size:18px;font-weight:500;}
#notification{margin-top:12px;font-size:14px;color:#ffcc00;font-weight:600;}
#game{display:grid;grid-template-columns:repeat(3,90px);grid-gap:16px;justify-content:center;margin:30px auto;}
.cell{width:90px;height:90px;font-size:2.5em;border-radius:24px;background:linear-gradient(145deg,#5022aa,#2f0e63);box-shadow:inset -4px -4px 12px rgba(255,255,255,0.08),inset 4px 4px 12px rgba(0,0,0,0.25),0 0 6px rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform 0.2s;}
.cell:hover{transform:scale(1.05);}
.cell.X{color:#00ffcc;text-shadow:0 0 8px #00ffcc,0 0 12px #00ffcc;}
.cell.O{color:#ff4d6d;text-shadow:0 0 8px #ff4d6d,0 0 12px #ff4d6d;}
#restart,#next,#reward-btn{margin-top:30px;padding:12px 28px;font-size:18px;background:linear-gradient(to right,#ff416c,#ff4b2b);border:none;color:white;border-radius:30px;box-shadow:0 0 18px rgba(255,65,108,0.8);cursor:pointer;display:inline-block;margin-left:8px;}
#next{display:none;}
#result-overlay{position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);font-size:2em;background:rgba(0,0,0,0.75);padding:20px 40px;border-radius:16px;display:none;z-index:1000;}
#result-overlay.show{display:block;}
.flash{animation:flash 0.5s alternate 4;}
@keyframes flash{from{background-color:rgba(255,255,255,0.12);}to{background-color:rgba(255,255,255,0.05);}}
</style>
</head>
<body>

<canvas id="star-canvas"></canvas>

<!-- Intro Screen -->
<div id="intro-screen">
  <div>Welcome</div>
  <div id="rainbow-text">Tic Tac Toe</div>
  <div>If you win, you are Legend</div>
</div>

<!-- Main Game -->
<div id="main-game">
<h2>Player vs Computer</h2>
<div id="status">Your turn (X)</div>
<div id="level">Level: 1 (Easy)</div>
<div id="points">XP: 0</div>
<div id="notification"></div>
<div id="game"></div>
<button id="restart">Restart</button>
<button id="next">Next</button>
<button id="reward-btn">Reward</button>
<div id="result-overlay"></div>
<audio id="gameover-sound" src="https://www.soundjay.com/button/sounds/button-29.mp3" preload="auto"></audio>
</div>

<script>
// Star background
const canvas = document.getElementById('star-canvas');
const ctx = canvas.getContext('2d');
let stars=[];
let shootingStars=[];
function resizeCanvas(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
window.addEventListener('resize',resizeCanvas);
resizeCanvas();

function initStars(count){
  stars=[];
  for(let i=0;i<count;i++){
    stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,size:Math.random()*2+1,speed:Math.random()*1.5+0.5});
  }
}
initStars(200);

function createShootingStar(){
  shootingStars.push({
    x:Math.random()*canvas.width,
    y:Math.random()*50,
    len:Math.random()*80+50,
    speed:Math.random()*10+6
  });
}
setInterval(createShootingStar,2000);

function drawStars(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // normal stars
  ctx.fillStyle="white";
  for(let s of stars){
    ctx.beginPath();
    ctx.arc(s.x,s.y,s.size,0,Math.PI*2);
    ctx.fill();
    s.y+=s.speed;
    if(s.y>canvas.height){ s.y=0; s.x=Math.random()*canvas.width; }
  }
  // shooting stars
  ctx.strokeStyle="white";
  ctx.lineWidth=2;
  for(let i=shootingStars.length-1;i>=0;i--){
    let s=shootingStars[i];
    ctx.beginPath();
    ctx.moveTo(s.x,s.y);
    ctx.lineTo(s.x+s.len,s.y+s.len);
    ctx.stroke();
    s.x+=s.speed; s.y+=s.speed;
    if(s.y>canvas.height || s.x>canvas.width){ shootingStars.splice(i,1); }
  }
  requestAnimationFrame(drawStars);
}
drawStars();
</script>

<script>
const tg = window.Telegram.WebApp; tg.expand();
const game=document.getElementById("game");
const statusText=document.getElementById("status");
const restartBtn=document.getElementById("restart");
const nextBtn=document.getElementById("next");
const rewardBtn=document.getElementById("reward-btn");
const levelText=document.getElementById("level");
const pointsText=document.getElementById("points");
const notification=document.getElementById("notification");
const resultOverlay=document.getElementById("result-overlay");
const gameoverSound=document.getElementById("gameover-sound");

let board=Array(9).fill("");
let gameActive=true;
let xp=0;
let notificationShown=false;

const winningCombinations=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

function getLevelName(levelNum){ const names=["Easy","Medium","Hard","Hardest"]; return names[(levelNum-1)%names.length]; }
function getLevel(){ return Math.min(xp+1,150); }

function createBoard(){ game.innerHTML=""; for(let i=0;i<9;i++){ const cell=document.createElement("div"); cell.classList.add("cell"); cell.dataset.index=i; cell.addEventListener("click",()=>playerMove(i)); game.appendChild(cell); } }

function updateBoard(){ document.querySelectorAll(".cell").forEach((cell,i)=>{ cell.textContent=board[i]; cell.classList.remove("X","O","flash"); if(board[i]) cell.classList.add(board[i]); }); const level=getLevel(); levelText.textContent=`Level: ${level} (${getLevelName(level)})`; pointsText.textContent=`XP: ${xp}`; }

function getEmptyIndices(){ return board.map((v,i)=>v===""?i:-1).filter(i=>i!==-1); }
function checkWin(player){ return winningCombinations.find(combo=>combo.every(i=>board[i]===player)); }
function isDraw(){ return board.every(cell=>cell!==""); }
function flashCells(combo){ combo.forEach(i=>document.querySelector(`.cell[data-index='${i}']`).classList.add("flash")); }
function showResult(text){ resultOverlay.textContent=text; resultOverlay.classList.add("show"); setTimeout(()=>resultOverlay.classList.remove("show"),2000); }
function playSound(){ gameoverSound.currentTime=0; gameoverSound.play(); }
function showSkipNotificationOnce(){ if(!notificationShown){ notification.textContent="You can skip the level by clicking Reward Button"; notificationShown=true; } }

function computerMove(){
  if(!gameActive) return;
  const empty=getEmptyIndices();
  if(empty.length===0) return;
  const level=getLevel();
  // Try to win
  for(let i of empty){ board[i]="O"; if(checkWin("O")){ finishComputerMove(i,"O"); return; } board[i]=""; }
  // Try to block
  for(let i of empty){ board[i]="X"; if(checkWin("X")){ board[i]="O"; finishComputerMove(i,"O"); return; } board[i]=""; }
  // Take center
  if(empty.includes(4)){ board[4]="O"; finishComputerMove(4,"O"); return; }
  // Take corners if higher level
  const corners=[0,2,6,8].filter(i=>board[i]==="");
  if(corners.length>0 && level>=30){ const move=corners[Math.floor(Math.random()*corners.length)]; board[move]="O"; finishComputerMove(move,"O"); return; }
  // Else random
  const move=empty[Math.floor(Math.random()*empty.length)]; board[move]="O"; finishComputerMove(move,"O");
}

function finishComputerMove(move,player){ updateBoard(); const win=checkWin(player); if(win){ flashCells(win); gameActive=false; playSound(); showResult("You Lose!"); showSkipNotificationOnce(); restartBtn.style.display='inline-block'; nextBtn.style.display='none'; return; } if(isDraw()){ gameActive=false; showResult("Draw!"); showSkipNotificationOnce(); restartBtn.style.display='inline-block'; nextBtn.style.display='none'; return; } statusText.textContent="Your turn (X)"; }

function playerMove(i){ if(!gameActive || board[i]!=="") return; board[i]="X"; updateBoard(); const win=checkWin("X"); if(win){ flashCells(win); gameActive=false; playSound(); showResult("You Win!"); xp=Math.min(xp+1,149); updateBoard(); nextBtn.style.display='inline-block'; restartBtn.style.display='none'; notification.textContent=""; notificationShown=false; return; } if(isDraw()){ gameActive=false; showResult("Draw!"); showSkipNotificationOnce(); restartBtn.style.display='inline-block'; nextBtn.style.display='none'; return; } statusText.textContent="Computer's turn (O)"; setTimeout(computerMove,500); }

function resetGame(){ board=Array(9).fill(""); gameActive=true; statusText.textContent="Your turn (X)"; updateBoard(); restartBtn.style.display='none'; nextBtn.style.display='none'; notification.textContent=""; notificationShown=false; }

async function showAdsAndContinue(incrementLevel=false){ try{ await window.showGiga(); if(incrementLevel){ xp=Math.min(xp+1,149); notificationShown=false; notification.textContent=""; } resetGame(); }catch(e){ alert("Ad failed to load. Please try again."); } }

restartBtn.addEventListener("click",resetGame);
rewardBtn.addEventListener("click",()=>{ showAdsAndContinue(true); });
nextBtn.addEventListener("click",()=>{ showAdsAndContinue(true); });

createBoard(); updateBoard();

/* Intro screen timer */
setTimeout(()=>{
  document.getElementById("intro-screen").style.display="none";
  document.getElementById("main-game").style.display="block";
},4000);
</script>
</body>
</html>
