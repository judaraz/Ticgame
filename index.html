<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tic Tac Toe Game</title>

<!-- Telegram Web App -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- RichAds SDK -->
<script src="https://richinfo.co/richpartners/telegram/js/tg-ob.js"></script>

<!-- GigaPub SDK (Fallback) -->
<script async src="https://ad.gigapub.tech/script?id=978"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#0a0a0a;color:#fff;overflow:hidden}
#intro{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;background:#0a0a0a;transition:opacity 1s}
#game-container{height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center}
#game{display:grid;grid-template-columns:repeat(3,100px);gap:16px;margin:20px}
.cell{width:100px;height:100px;font-size:3em;border-radius:20px;background:#2f0e63;display:flex;align-items:center;justify-content:center;cursor:pointer}
.cell.X{color:#00ffcc}
.cell.O{color:#ff4d6d}
button{margin:8px;padding:10px 20px;font-size:18px;border:none;border-radius:20px;cursor:pointer}
#restart{background:#ff416c;color:#fff}
#next{background:#ffd700;color:#000}
#reward-btn{background:#00ffcc;color:#000}
</style>
</head>

<body>

<div id="intro">
  <h1>Welcome</h1>
  <h2>Tic Tac Toe</h2>
  <h3>If you win you are Legend</h3>
</div>

<div id="game-container">
  <div id="status">Your turn (X)</div>
  <div id="level">Level: 1</div>
  <div id="points">XP: 0</div>

  <div id="game"></div>

  <button id="restart">Restart</button>
  <button id="next">Next</button>
  <button id="reward-btn">Watch Ads to Get Next Level</button>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

/* ===============================
   INIT RICH ADS (ALL TYPES)
================================ */
let RichReady = false;

try {
  window.TelegramAdsController = new TelegramAdsController();
  TelegramAdsController.initialize({
    pubId: "956231",
    appId: "5476",
  });

  // preload everything
  TelegramAdsController.loadPush();
  TelegramAdsController.loadEmbedded();
  TelegramAdsController.loadInterstitial();
  TelegramAdsController.loadRewarded();

  RichReady = true;
} catch (e) {
  RichReady = false;
}

/* ===============================
   AD HANDLER (Rich â†’ Giga)
================================ */
function showAdThenContinue(callback) {
  let finished = false;
  const done = () => {
    if (finished) return;
    finished = true;
    callback();
  };

  // Hard safety timeout
  setTimeout(done, 2500);

  if (RichReady) {
    try {
      // Try video first
      TelegramAdsController.showRewarded()
        .then(done)
        .catch(() => {
          // Fallback to interstitial banner
          try {
            TelegramAdsController.showInterstitial();
            setTimeout(done, 800);
          } catch {
            fallbackGiga(done);
          }
        });
      return;
    } catch {}
  }

  fallbackGiga(done);
}

function fallbackGiga(done) {
  if (typeof window.showGiga === "function") {
    window.showGiga()
      .then(done)
      .catch(done);
  } else {
    done();
  }
}

/* ===============================
   GAME LOGIC
================================ */
const game = document.getElementById("game");
const statusText = document.getElementById("status");
const levelText = document.getElementById("level");
const pointsText = document.getElementById("points");

let board = Array(9).fill("");
let active = true;
let finished = false;
let level = 1;
let xp = 0;

const wins = [
  [0,1,2],[3,4,5],[6,7,8],
  [0,3,6],[1,4,7],[2,5,8],
  [0,4,8],[2,4,6]
];

function createBoard(){
  game.innerHTML="";
  board.forEach((_,i)=>{
    const c=document.createElement("div");
    c.className="cell";
    c.onclick=()=>move(i);
    game.appendChild(c);
  });
}

function update(){
  [...game.children].forEach((c,i)=>{
    c.textContent=board[i];
    c.className="cell "+board[i];
  });
}

function win(p){return wins.some(w=>w.every(i=>board[i]===p))}
function draw(){return board.every(v=>v)}

function move(i){
  if(!active||board[i])return;
  board[i]="X";update();
  if(win("X"))return end("You Win!");
  if(draw())return end("Draw!");
  setTimeout(ai,400);
}

function ai(){
  const e=board.map((v,i)=>v?null:i).filter(v=>v!==null);
  if(!e.length)return;
  board[e[Math.floor(Math.random()*e.length)]]="O";
  update();
  if(win("O"))end("You Lose!");
}

function end(msg){
  alert(msg);
  statusText.textContent=msg;
  active=false;
  finished=true;
}

function reset(){
  board.fill("");
  active=true;
  finished=false;
  statusText.textContent="Your turn (X)";
  update();
}

/* ===============================
   BUTTONS
================================ */
document.getElementById("restart").onclick=reset;

document.getElementById("next").onclick=()=>{
  if(!finished)return;
  showAdThenContinue(()=>{
    level++;xp++;
    levelText.textContent="Level: "+level;
    pointsText.textContent="XP: "+xp;
    reset();
  });
};

document.getElementById("reward-btn").onclick=()=>{
  showAdThenContinue(()=>{
    level++;xp++;
    levelText.textContent="Level: "+level;
    pointsText.textContent="XP: "+xp;
    reset();
  });
};

/* ===============================
   INTRO
================================ */
setTimeout(()=>{
  document.getElementById("intro").style.opacity="0";
  setTimeout(()=>{
    document.getElementById("intro").remove();
    createBoard();
    update();
  },1000);
},2500);
</script>

</body>
</html>
