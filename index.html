<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tic Tac Toe Game</title>

<!-- Telegram Web App -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- GigaPub Ads -->
<script src="https://ad.gigapub.tech/script?id=978"></script>

<!-- Firebase Compat SDK -->
<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>

<style>
  body { margin:0; font-family: Arial, sans-serif; background:#0a0a0a; overflow:hidden; color:white; position:relative;}
  
  /* Intro Screen */
  #intro { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; z-index:1000; background:#0a0a0a; }
  #intro h1 { font-size:3em; margin:0; color:#FFD700; text-shadow:2px 2px #000;}
  #intro h2 { font-size:2em; margin:5px 0; color:#00FFCC; text-shadow:2px 2px #000;}
  #intro h3 { font-size:1.5em; margin:5px 0; color:#FF4D6D; text-shadow:2px 2px #000;}

  /* Stars Canvas */
  #stars { position:fixed; inset:0; z-index:0; pointer-events:none; background:#0a0a0a; }

  /* Game Container */
  #game-container { position:relative; z-index:1; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh;}
  #game { display:grid; grid-template-columns:repeat(3,100px); grid-gap:16px; margin-top:20px; }
  .cell { width:100px; height:100px; font-size:3em; border-radius:20px; background:linear-gradient(145deg,#5022aa,#2f0e63); display:flex; align-items:center; justify-content:center; cursor:pointer; }
  .cell.X { color:#00FFCC; text-shadow:0 0 8px #00FFCC; }
  .cell.O { color:#FF4D6D; text-shadow:0 0 8px #FF4D6D; }

  #status,#level,#points,#notification { margin:5px; font-size:18px; font-weight:bold; text-align:center;}
  #restart,#next,#reward-btn { margin:10px; padding:10px 20px; font-size:18px; border:none; border-radius:20px; cursor:pointer; }
  #restart{background:linear-gradient(to right,#ff416c,#ff4b2b); color:white;}
  #next{background:linear-gradient(to right,#ffb700,#ffd700); color:black; display:none;}
  #reward-btn{background:linear-gradient(to right,#00ffcc,#00bfff); color:black;}
  #result-overlay { position:fixed; top:40%; left:50%; transform:translate(-50%,-50%); font-size:2em; background:rgba(0,0,0,0.75); padding:20px 40px; border-radius:16px; display:none; z-index:1000; }

  /* Win/Lose Glow */
  #win-glow,#lose-glow { position:absolute; inset:0; z-index:0; pointer-events:none; opacity:0; }
  #win-glow { background: radial-gradient(circle, rgba(255,215,0,0.4) 0%, transparent 70%); }
  #lose-glow { background: radial-gradient(circle, rgba(255,0,0,0.3) 0%, transparent 70%); }
</style>
</head>
<body>

<!-- Intro Screen -->
<div id="intro">
  <h1>Welcome</h1>
  <h2>Tic Tac Toe</h2>
  <h3>If you win you are Legend</h3>
</div>

<!-- Stars Background -->
<canvas id="stars"></canvas>

<!-- Game Container -->
<div id="game-container">
  <h2>Player vs Computer</h2>
  <div id="status">Your turn (X)</div>
  <div id="level">Level: 1 (Easy)</div>
  <div id="points">XP: 0</div>
  <div id="notification"></div>
  <div id="game"></div>
  <button id="restart">Restart</button>
  <button id="next">Next</button>
  <button id="reward-btn">Reward</button>
  <div id="result-overlay"></div>
  <div id="win-glow"></div>
  <div id="lose-glow"></div>

  <audio id="gameover-sound" src="https://www.soundjay.com/button/sounds/button-29.mp3" preload="auto"></audio>
</div>

<script>
// Telegram Init
const tg = window.Telegram.WebApp;
tg.expand();
const userId = tg.initDataUnsafe?.user?.id || 'guest_' + Math.floor(Math.random()*10000);
const userName = tg.initDataUnsafe?.user?.username || 'Guest';

// Firebase Init
const firebaseConfig = {
  apiKey: "AIzaSyA3palpYZDFdNpBDIF564YsiOAN2dtbxzA",
  authDomain: "tic-tac-toe-87d49.firebaseapp.com",
  projectId: "tic-tac-toe-87d49",
  storageBucket: "tic-tac-toe-87d49.appspot.com",
  messagingSenderId: "1051665363188",
  appId: "1:1051665363188:web:c6389dddb74491a14ceea1",
  measurementId: "G-V7Y7B4VVVP"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Game Variables
const game = document.getElementById("game");
const statusText = document.getElementById("status");
const restartBtn = document.getElementById("restart");
const nextBtn = document.getElementById("next");
const rewardBtn = document.getElementById("reward-btn");
const levelText = document.getElementById("level");
const pointsText = document.getElementById("points");
const notification = document.getElementById("notification");
const resultOverlay = document.getElementById("result-overlay");
const winGlow = document.getElementById("win-glow");
const loseGlow = document.getElementById("lose-glow");
const gameoverSound = document.getElementById("gameover-sound");

let board = Array(9).fill("");
let gameActive = true;
let xp = 0;
let notificationShown = false;
const winningCombinations = [
  [0,1,2],[3,4,5],[6,7,8],
  [0,3,6],[1,4,7],[2,5,8],
  [0,4,8],[2,4,6]
];

function getLevelName(levelNum){ const names = ["Easy","Medium","Hard","Legendary"]; return names[(levelNum-1)%names.length]; }
function getLevel(){ return Math.min(xp+1,201); }

// Firebase Load User
async function loadUserData(){
  try{
    const docSnap = await db.collection("users").doc(userId).get();
    if(docSnap.exists){
      xp = docSnap.data().xp || 0;
    }
  } catch(e){ console.error(e); }
}

// Firebase Save User
function saveUserData(){
  db.collection("users").doc(userId).set({
    name:userName,
    xp:xp
  }).catch(e=>console.error(e));
}

// Board
function createBoard(){
  game.innerHTML = "";
  for(let i=0;i<9;i++){
    const cell=document.createElement("div");
    cell.classList.add("cell");
    cell.dataset.index=i;
    cell.addEventListener("click",()=>playerMove(i));
    game.appendChild(cell);
  }
}

// Update UI
function updateBoard(){
  document.querySelectorAll(".cell").forEach((cell,i)=>{
    cell.textContent=board[i];
    cell.classList.remove("X","O");
    if(board[i]) cell.classList.add(board[i]);
  });
  const level=getLevel();
  levelText.textContent=`Level: ${level} (${getLevelName(level)})`;
  pointsText.textContent=`XP: ${xp}`;
}

// Helper
function getEmptyIndices(){ return board.map((v,i)=>v===""?i:-1).filter(i=>i!==-1); }
function checkWin(player){ return winningCombinations.find(c=>c.every(i=>board[i]===player)); }
function isDraw(){ return board.every(c=>c!==""); }
function flashCells(combo){ combo.forEach(i=>document.querySelector(`.cell[data-index='${i}']`).classList.add("flash")); }

// Result Overlay
function showResult(text,win=false){
  resultOverlay.textContent=text;
  resultOverlay.style.display="block";
  if(win){ winGlow.style.opacity=1; }
  else{ loseGlow.style.opacity=1; }
  setTimeout(()=>{ resultOverlay.style.display="none"; winGlow.style.opacity=0; loseGlow.style.opacity=0; },2000);
}

// Sounds
function playSound(){ gameoverSound.currentTime=0; gameoverSound.play(); }

// AI
function computerMove(){
  if(!gameActive) return;
  const empty=getEmptyIndices();
  if(empty.length===0) return;

  // AI tries to win/block
  let move=-1;
  // Win if possible
  for(let combo of winningCombinations){
    const vals=combo.map(i=>board[i]);
    if(vals.filter(v=>"O"===v).length===2 && vals.includes("")) move=combo[vals.indexOf("")];
  }
  // Block player
  if(move===-1){
    for(let combo of winningCombinations){
      const vals=combo.map(i=>board[i]);
      if(vals.filter(v=>"X"===v).length===2 && vals.includes("")) move=combo[vals.indexOf("")];
    }
  }
  // Else random
  if(move===-1) move=empty[Math.floor(Math.random()*empty.length)];

  board[move]="O";
  updateBoard();
  const win=checkWin("O");
  if(win){
    flashCells(win);
    gameActive=false;
    playSound();
    showResult("You Lose!", false);
    restartBtn.style.display='inline-block';
    nextBtn.style.display='none';
    return;
  } else if(isDraw()){
    gameActive=false;
    showResult("Draw!", false);
    restartBtn.style.display='inline-block';
    nextBtn.style.display='none';
    return;
  } else{
    statusText.textContent="Your turn (X)";
  }
}

// Player Move
function playerMove(i){
  if(!gameActive || board[i]!=="") return;
  board[i]="X";
  updateBoard();
  const win=checkWin("X");
  if(win){
    flashCells(win);
    gameActive=false;
    playSound();
    xp=Math.min(xp+1,201);
    saveUserData();
    showResult("You Win!", true);
    nextBtn.style.display='inline-block';
    restartBtn.style.display='none';
    notification.textContent="";
    notificationShown=false;
    return;
  }
  if(isDraw()){
    gameActive=false;
    showResult("Draw!", false);
    restartBtn.style.display='inline-block';
    nextBtn.style.display='none';
    return;
  }
  statusText.textContent="Computer's turn (O)";
  setTimeout(computerMove, 500);
}

// Reset Game
function resetGame(){
  board=Array(9).fill("");
  gameActive=true;
  statusText.textContent="Your turn (X)";
  updateBoard();
  restartBtn.style.display='none';
  nextBtn.style.display='none';
  notification.textContent="";
  notificationShown=false;
}

// Show Ads
async function showAdsAndContinue(increment=false){
  try{
    await window.showGiga();
    if(increment){ xp=Math.min(xp+1,201); saveUserData(); }
    resetGame();
  } catch(e){ alert("Ad failed to load. Please try again."); }
}

restartBtn.addEventListener("click", resetGame);
rewardBtn.addEventListener("click", ()=>showAdsAndContinue(true));
nextBtn.addEventListener("click", ()=>showAdsAndContinue(true));

createBoard();
updateBoard();
loadUserData();

// Intro Fade Out
setTimeout(()=>{ document.getElementById("intro").style.display="none"; },3000);

// Stars Background
const canvas=document.getElementById("stars");
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;
const ctx=canvas.getContext("2d");
let stars=[];
for(let i=0;i<150;i++){
  stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*1.2+0.5,speed:Math.random()*0.5+0.1});
}
function drawStars(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="white";
  stars.forEach(s=>{
    ctx.beginPath();
    ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
    ctx.fill();
    s.y+=s.speed;
    if(s.y>canvas.height){ s.y=0; s.x=Math.random()*canvas.width; }
  });
  requestAnimationFrame(drawStars);
}
drawStars();
</script>
</body>
</html>
